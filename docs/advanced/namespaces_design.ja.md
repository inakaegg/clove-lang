# 名前空間設計ノート (`ns` / `require`)

このドキュメントは、Clove の名前空間 (`ns`) と `require` 周りの設計メモです。

* Clove の `ns` は Clojure に近いが、実装上の制約や方針が少し異なる
* 「1 名前空間 = 1 ファイル」を基本とする
* ファイルパスと名前空間の対応
* `require` のバリエーションと auto-load

---

## 1. 基本方針

### 1.1 「1 名前空間 = 1 ファイル」が基本

現時点の実装では、以下のような方針を取っています。

* 1 つのファイルに 1 つの `ns` 宣言
* 同じ `ns` 名を複数ファイルで使うとエラー（または強めの警告）
* 「partial ns」（1 名前空間を複数ファイルに分割）はサポートしない

理由:

* 実装をシンプルに保つため
* LSP / リンク機能（go-to-definition 等）で「この ns はこのファイル」と一意に扱える
* 将来のコンパイル / ビルドパイプラインを扱いやすくするため

将来的に「partial ns」を許すかもしれませんが、現在は「1 ns = 1 ファイル」を前提としています。

### 1.2 名前空間名のルール

実装・議論中のルール:

* `ns` 名には `-` を含めない（将来的にどうするかは検討中）
* `_` は許可する
* Ruby や Clojure と違い、**`::` 区切り** を採用

例:

```clojure
(ns myapp::core)
(ns myapp::api::server)
(ns my_app::util)
```

---

## 2. ファイルパスとの対応

### 2.1 推奨マッピング

慣習として、以下のような対応を推奨しています。

| 名前空間             | ファイルパス                 |
| ---------------- | ---------------------- |
| `myapp::core`    | `src/myapp/core.clv`   |
| `myapp::api`     | `src/myapp/api.clv`    |
| `myapp::api::v1` | `src/myapp/api/v1.clv` |

* `::` → `/`（ディレクトリ区切り）
* 最後の要素をファイル名 (`.clv`) にする

実装側の `NamespaceStore` などで、`ns` 名とファイルの対応を記録し、
同じ `ns` が別ファイルで定義されていないかチェックしています。

### 2.2 ゆるい運用と警告

現時点では **強制ではなく「推奨」** として扱い、
完全にズレていても即座にエラーにしない方針です。

将来:

* `clove check` 的なコマンドで「名前空間とファイルパスがズレている」ことを警告
* 一部を「ERROR」ではなく「WARN」として扱う

などの運用に寄せる予定です。

---

## 3. `require` の設計

### 3.1 基本形

```clojure
(ns myapp::ui
  (require myapp::core :as core))

(core::area 10)
```

* `require` は Clojure と同様、名前空間シンボルを受け取ります。
* `:as` / `:refer` / `:rename` などをサポートしています。

### 3.2 `quote` について

Clove では、`require` において Clojure のような `'ns-name` 形式は必須ではありません。

```clojure
(require myapp::core :as core)
;; OK

(require 'myapp::core :as core)
;; `'` の reader マクロを入れるかどうかは別途検討
```

* 現時点では `'` は `(quote ...)` として動きますが、
* マクロシステム（`defmacro` / 準クォート etc.）をまだ入れていないこともあり、
* `require` では「素直にシンボルを書いてもらう」設計を優先しています。

---

## 4. auto-load と依存解決

Clove のランタイム側では

1. `ns` 宣言を読んで「このファイルはこの名前空間」と記録
2. `require` されたときに、対応するファイルを探してロード

という流れで依存関係を解決します。

* 探索パス:

  * プロジェクトルート配下（例: `src/` や [examples/](/examples/)）
  * `CLASSPATH` 的な設定が入る可能性もある（要検討）
* 1 つの名前空間が別のファイルにも見つかった場合:

  * エラーまたは強めの警告

---

## 5. Clojure / Ruby との比較

### 5.1 Clojure

* `ns` / `require` はほぼ同じ概念
* `clojure.core` が暗黙にインポートされる
* `-` / `_` の扱いなど、シンボル名に関する流儀が Clove と少し違う

### 5.2 Ruby

* モジュール名とファイルパスの対応は「慣習」であり強制ではない
* `require "my_app/core"` などでロードする
* 名前空間（Module / Class）とファイル構造がズレても動くが、
  後から整理するときに辛くなりやすい

Clove は Ruby より Clojure 寄りですが、
「最初から厳しく縛る」というよりは「ガイドと警告で誘導する」方針をとっています。

---

## 6. 今後の検討事項

* 1 名前空間複数ファイル（partial ns）をどこまで許容するか

  * テスト用 / 実験用として許すのか、完全禁止にするのか
* `ns` とファイルパスの対応をどこまで強制 / 検査するか
* `clove check` / `clove lint` のような静的チェックコマンドの導入
* LSP との連携

  * `go-to-definition` / `find-references` などが名前空間情報に強く依存

---

## 7. まとめ

* Clove の `ns` / `require` は Clojure にかなり似ているが、実装の都合でいくつか方針が違う。
* 現時点では「1 名前空間 = 1 ファイル」を基本としている。
* 名前空間名には `::` 区切りを使い、ファイルパスと対応をとることを推奨。
* 厳格な制約というより「LSP / ビルド / ドキュメント生成をやりやすくするためのガイド」として設計している。

---
<!-- NAV:START -->
**前へ:** [型（設計・型ヒント・typed build の前提）](typing.ja.md)
**次へ:** [メモ化と永続キャッシュ（memo / memoize）](memoization.ja.md)
<!-- NAV:END -->

